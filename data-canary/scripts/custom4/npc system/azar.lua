AZAR_TASKS = 
{ 
_maxTasksForPlayer = 1,

[1] = { name = "Teleskor",
        monsterList = { "Teleskor" },
		minLevel = 8,
		maxLevel = 2000,
		kills = 1, 
		["Rewards"] = { 
		                { type = "experience", value = 20000 },
						{ type = "item", item_id = 2268, count = 1 },
					  }
	   },
[2] = { name = "The Old Widow",
        monsterList = { "The Old Widow" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
 [3] = { name = "Fernfang",
        monsterList = { "Fernfang" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[4] = { name = "Demodras",
        monsterList = { "Demodras" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[5] = { name = "Tromphonyte",
        monsterList = { "Tromphonyte" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[6] = { name = "Ribstride",
        monsterList = { "Ribstride" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[7] = { name = "Zomba",
        monsterList = { "Zomba" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[8] = { name = "Munster",
        monsterList = { "Munster" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[9] = { name = "Boogey",
        monsterList = { "Boogey" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[10] = { name = "Irgix The Flimsy",
        monsterList = { "Irgix The Flimsy" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[11] = { name = "The Baron from Below",
        monsterList = { "The Baron from Below" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[12] = { name = "The Baron from Below",
        monsterList = { "The Baron from Below" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[13] = { name = "The Voice Of Ruin",
        monsterList = { "The Voice Of Ruin" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[14] = { name = "The Baron from Below",
        monsterList = { "The Baron from Below" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[15] = { name = "Hirintror",
        monsterList = { "Hirintror" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[16] = { name = "Sir Valorcrest",
        monsterList = { "Sir Valorcrest" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[17] = { name = "The Pale Count",
        monsterList = { "The Pale Count" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[18] = { name = "Lisa",
        monsterList = { "Lisa" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[19] = { name = "Man in the Cave",
        monsterList = { "Man in the Cave" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[20] = { name = "Countess Sorrow",
        monsterList = { "Countess Sorrow" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[21] = { name = "Orshabaal",
        monsterList = { "Orshabaal" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[22] = { name = "The Count of the Core",
        monsterList = { "The Count of the Core" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[23] = { name = "Mr. Punish",
        monsterList = { "Mr. Punish" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[24] = { name = "Mahrdis",
        monsterList = { "Mahrdis" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[25] = { name = "Mr. Punish",
        monsterList = { "Mr. Punish" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[26] = { name = "The Old Whopper",
        monsterList = { "The Old Whopper" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[27] = { name = "Brokul",
        monsterList = { "Brokul" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[28] = { name = "Terofar",
        monsterList = { "Terofar" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },
[29] = { name = "Lady Tenebris",
        monsterList = { "Lady Tenebris" },
		minLevel = 5,
		maxLevel = 100000,
		kills = 3, 
		["Rewards"] = { 
		                { type = "experience", value = 40000 },
						{ type = "item", item_id = 2789, count = 50 },
					  }
	   },

}




AZAR_STORAGES = 
{
start = 78781,
checkTask = 47770,
killTask = 47870,
countTask = 47970,
bossTask = 48770,
dificult = 49770,
index = 50770,
}

azarTask = { }
azarTask.__newindex = azarTask

AZAR_TASKS._reportTaskMode = "normal"
AZAR_TASKS._trackerIndex = 0
local function prepare()
	local questIndex = 1
	while true do
		if (not Quests[questIndex]) then
			Quests[questIndex] = {
		            name = "Boss Tasks",
		            startStorageId = AZAR_STORAGES.start,
                    startStorageValue = 1,
					missions = {}
					}
			AZAR_TASKS._trackerIndex = questIndex
			break
		end
		questIndex = questIndex + 1
	end
	
for i = 1, #AZAR_TASKS do
	local values = { 
	                  name = AZAR_TASKS[i].name,
					  storageId = AZAR_STORAGES.checkTask + i,
					  missionId = AZAR_STORAGES.checkTask + i,
					  startValue = 1,
					  endValue = 3,
					  states = {
					             [1] = function(player)
								       local kills = AZAR_TASKS[i].kills
					                   local playerKills = player:getStorageValue(AZAR_STORAGES.killTask + i)
					                   if playerKills < 0 then
					                      playerKills = 0
				                       end  
					                   local countKills = AZAR_TASKS[i].kills - playerKills
					                   local monsterList = AZAR_TASKS[i].monsterList
					                   local list = ""
					                   for i = 1, #monsterList do
					                       if i == #monsterList then
						                      list = list .. monsterList[i]:lower() .. "."
							               else
							                  list = list .. monsterList[i]:lower() .. ", "
						                   end
					                   end
									   return string.format("You have to kill " .. AZAR_TASKS[i].name .. "s." .. "\n" .. "Avaible Monsters: " .. list .. "\n" .. "Monsters Left: " .. countKills)
									   end,
								 [2] = "You have finished this task, Report to Azar to get reward.",
								 [3] = "Task is completed."
							   }
								        
					  
					  -- description = function(player)
					  -- local kills = AZAR_TASKS[i].kills
					  -- local playerKills = player:getStorageValue(AZAR_STORAGES.killTask + i)
					  -- if playerKills < 0 then
					     -- playerKills = 0
				      -- end  
					  -- local countKills = AZAR_TASKS[i].kills - playerKills
					  -- local monsterList = AZAR_TASKS[i].monsterList
					  -- local list = ""
					  -- for i = 1, #monsterList do
					      -- if i == #monsterList then
						     -- list = list .. monsterList[i]:lower() .. "."
							 -- else
							 -- list = list .. monsterList[i]:lower() .. ", "
						  -- end
					  -- end
					 
					  -- if player:getStorageValue(AZAR_STORAGES.checkTask + i) <= 0 then
					     -- print("ZWRACAM GOWNO")
					     -- return "kutas"
				      -- end
							
					     -- if countKills <= 0 then
					        -- return string.format("You have finished this task, report to npc.")
						 -- else
					        -- return string.format("You have to kill " .. AZAR_TASKS[i].name .. "s." .. "\n" .. "Avaible Monsters: " .. list .. "\n" .. "Monsters Left: " .. countKills)
						 -- end
					  -- end
				    }
	table.insert(Quests[questIndex].missions, values)
   end
end

local globalevent = GlobalEvent("load_Azar")
function globalevent.onStartup()
	prepare()
end
globalevent:register()

function azarTask:updateTracker(player, key, logg)
    
	if logg then
	end
	
	local missions = player:getMissionsData(key)
	
	for i = 1, #missions do
		local mission = missions[i]
		if player:hasTrackingQuest(mission.missionId) then
		   player:sendUpdateTrackedQuest(mission)
		   player:sendTextMessage(MESSAGE_EVENT_ADVANCE, "Your questlog has been updated.")
		end
	end
	
end

function azarTask:resetTracker(player, key, index)

	local missions = Quests
	
	
	
	
	local q = {}

	for i = 1, #missions do
	    local mission = missions[i]
		local id = mission.missionId
		if id == key + index then
	       table.insert(q, mission.missionId)
		end
	end	

	player:resetTrackedMissions(q)
end

function azarTask:updateTasks(player, creature)
      
	  if not player then
	     return nil
	  end
	  
	  for i = 1, #AZAR_TASKS do
		  if isInArray(AZAR_TASKS[i].monsterList, creature:getName()) then
	         local checkTask = player:getStorageValue(AZAR_STORAGES.checkTask + i)
	         local kill = player:getStorageValue(AZAR_STORAGES.killTask + i)
		  
		  	if checkTask > 0 then
	           if kill == nil or kill == -1 then
	              player:setStorageValue(AZAR_STORAGES.killTask + i, 1)
	              kill = player:getStorageValue(AZAR_STORAGES.killTask + i)
	           else
	              player:setStorageValue(AZAR_STORAGES.killTask + i, kill + 1)
	              kill = player:getStorageValue(AZAR_STORAGES.killTask + i)
	           end

	           if kill > AZAR_TASKS[i].kills then
	              return true
	           end
	   
	           --local channelID = 14
	           --player:openChannel(channelID)
			   
			   azarTask:updateTracker(player, AZAR_STORAGES.checkTask + i)

               if kill == AZAR_TASKS[i].kills then
	             -- player:sendChannelMessage("[TASK SYSTEM - Boss]", "[" .. AZAR_TASKS[i].name .. " Task" .. "] - " .. "[" .. kill .. "/" .. AZAR_TASKS[i].kills .. "]" .. ".", TALKTYPE_CHANNEL_O, channelID)
		         -- player:sendChannelMessage("[TASK SYSTEM - Boss]", "[" .. AZAR_TASKS[i].name .. " Task" .. "] - " .. "You have killed all bosses, report to npc.", TALKTYPE_CHANNEL_O, channelID)
                  player:setStorageValue(AZAR_STORAGES.checkTask + i, 2)
               else
	              --player:sendChannelMessage("[TASK SYSTEM - Boss]", "[" .. AZAR_TASKS[i].name .. " Task" .. "] - " .. "[" .. kill .. "/" .. AZAR_TASKS[i].kills .. "]" .. ".", TALKTYPE_CHANNEL_O, channelID)
		          return true
	           end
			   
			   
	        end
		end
	end
end
	  
local creaturescript = CreatureEvent("azar_onDeath")
function creaturescript.onDeath(creature, corpse, killer, mostDamage, unjustified, mostDamage_unjustified)	
    
    if not creature:isMonster() then
        return false
    end
	
    if creature:getMaster() ~= nil then
        return false
    end
	
    local player = Player(mostDamage)
	if not player then
	   return false
	end
	
	local party = player:getParty() 
	if party then
	   if party:isSharedExperienceEnabled() then
	      local members = party:getMembers()
		  if members then
			 for _, member in pairs(members) do
				azarTask:updateTasks(member, creature)
			 end
		  end
		  local leader = party:getLeader() 
		  if leader then
		     azarTask:updateTasks(leader, creature) 
		  end
	   return true
	   end
	end
	
	azarTask:updateTasks(player, creature)
	return true
end
creaturescript:register()


