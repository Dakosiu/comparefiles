-- CREATE TABLE `game_events` (
-- `name` varchar(30) NOT NULL,
-- `points` bigint(20) NOT NULL,
-- `restarted` bigint(20) NOT NULL
-- ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
-- INSERT INTO `game_events` (`name`, `points`, `restarted`) VALUES ('larvik_npc', '0', '0');

LARVIK_TASKS = {
                 ["Informations Table"] = {
				                           ["Position"] = { 894, 1041, 7 }
							             },
                 ["Schedulers"] = {
				                    ["Daily"] = { Time = "15:22" },
									["Weekly Points Reset"] = { Day = "Saturday" },
									["Activation Days"] = { "Wednesday" }
									                        
								  },
                 ["Easy"] = {
				              [1] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 3042, count = 10 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},
				              [2] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 9657, count = 20 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},
							  [3] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 9691, count = 20 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 3 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [4] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 11481, count = 30 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},
							  [5] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 25701, count = 20 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},
							  [6] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 17462, count = 20 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},
							  [7] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 39336, count = 20 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},
							  [8] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 19111, count = 20 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},
							  [9] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 19110, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},
							  [10] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 9649, count = 20 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [11] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 17809, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [12] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 18995, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [13] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 11444, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [14] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 11443, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [15] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 17463, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [16] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 17461, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [17] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 17458, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},
							  [18] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 5925, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [19] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 9692, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [20] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 11466, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [21] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 17817, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [22] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 10291, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [23] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 10283, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [24] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 17819, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},	
							  [25] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 10275, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 100000 },
													 { type = "item", id = 3043, count = 5 },
													 { type = "item", id = 32771, count = 3 },
												   }
									},										
							},
                 ["Medium"] = {
				              [1] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 9685, count = 10 },
															 { type = "item", id = 5920, count = 15 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 300000 },
													 { type = "item", id = 3043, count = 15 },
													 { type = "item", id = 32771, count = 9 },
												   }
									},
				              [2] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 5948, count = 6 },
															 { type = "item", id = 5882, count = 12 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 300000 },
													 { type = "item", id = 3043, count = 15 },
													 { type = "item", id = 32771, count = 9 },
												   }
									},
							  [3] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 9666, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 300000 },
													 { type = "item", id = 3043, count = 15 },
													 { type = "item", id = 32771, count = 9 },
												   }
									},
							  [4] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 11449, count = 30 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 300000 },
													 { type = "item", id = 3043, count = 15 },
													 { type = "item", id = 32771, count = 9 },
												   }
									},
							  [5] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 21203, count = 30 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 300000 },
													 { type = "item", id = 3043, count = 15 },
													 { type = "item", id = 32771, count = 9 },
												   }
									},
							  [6] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 3658, count = 25 },
															 { type = "item", id = 25691, count = 5 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 300000 },
													 { type = "item", id = 3043, count = 15 },
													 { type = "item", id = 32771, count = 9 },
												   }
									},
							  [7] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 10408, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 300000 },
													 { type = "item", id = 3043, count = 15 },
													 { type = "item", id = 32771, count = 9 },
												   }
									},
							  [8] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 22189, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 300000 },
													 { type = "item", id = 3043, count = 15 },
													 { type = "item", id = 32771, count = 9 },
												   }
									},
							  [9] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 12312, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 300000 },
													 { type = "item", id = 3043, count = 15 },
													 { type = "item", id = 32771, count = 9 },
												   }
									},
							  [10] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 35574, count = 15 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 300000 },
													 { type = "item", id = 3043, count = 15 },
													 { type = "item", id = 32771, count = 9 },
												   }
									},
							  [11] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 17851, count = 15 },
															 { type = "item", id = 17857, count = 8 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 300000 },
													 { type = "item", id = 3043, count = 15 },
													 { type = "item", id = 32771, count = 9 },
												   }
									},
							  [12] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 11680, count = 25 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 300000 },
													 { type = "item", id = 3043, count = 15 },
													 { type = "item", id = 32771, count = 9 },
												   }
									},
							},
                 ["Hard"] = {
				              [1] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 31438, count = 40 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 900000 },
													 { type = "item", id = 3043, count = 25 },
													 { type = "item", id = 32771, count = 12 },
												   }
									},
				              [2] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 16135, count = 40 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 900000 },
													 { type = "item", id = 3043, count = 25 },
													 { type = "item", id = 32771, count = 12 },
												   }
									},
							  [3] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 33943, count = 40 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 900000 },
													 { type = "item", id = 3043, count = 25 },
													 { type = "item", id = 32771, count = 12 },
												   }
									},	
							  [4] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 16139, count = 40 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 900000 },
													 { type = "item", id = 3043, count = 25 },
													 { type = "item", id = 32771, count = 12 },
												   }
									},	
							  [5] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 31678, count = 40 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 900000 },
													 { type = "item", id = 3043, count = 25 },
													 { type = "item", id = 32771, count = 12 },
									               }
									},	
							  [6] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 20198, count = 40 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 900000 },
													 { type = "item", id = 3043, count = 25 },
													 { type = "item", id = 32771, count = 12 },
												   }
									},	
							  [7] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 32227, count = 40 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 900000 },
													 { type = "item", id = 3043, count = 25 },
													 { type = "item", id = 32771, count = 12 },
												   }
									},	
							  [8] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 31442, count = 40 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 900000 },
													 { type = "item", id = 3043, count = 25 },
													 { type = "item", id = 32771, count = 12 },
												   }
									},	
							  [9] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 28567, count = 40 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 900000 },
													 { type = "item", id = 3043, count = 25 },
													 { type = "item", id = 32771, count = 12 },
												   }
									},		
							  [10] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 28566, count = 40 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 900000 },
													 { type = "item", id = 3043, count = 25 },
													 { type = "item", id = 32771, count = 12 },
												   }
									},	
							  [11] = { 
							          ["Required Items"] = { 
									                         { type = "item", id = 9663, count = 20 },
														   },
									  ["Reward"] = {
									                 { type = "experience", value = 900000 },
													 { type = "item", id = 3043, count = 25 },
													 { type = "item", id = 32771, count = 12 },
												   }
									},											
							}
				}
        
larvikTask = { }
larvikTask.__newindex = larvikTask
larvikTask.start = 15313
larvikTask.selectedTask = 16471
larvikTask.selectedTaskEasy = 26471
larvikTask.selectedTaskMedium = 27472
larvikTask.selectedTaskHard = 28473
larvikTask.selectedCount = 17425
larvikTask.isDoingTask = 18535
larvikTask.actionid = 4441
larvikTask.canUse = false

local function prepare()
	local questIndex = 1
	while true do
		if (not Quests[questIndex]) then
			Quests[questIndex] = {
		            name = "Larvik Tasks",
		            startStorageId = larvikTask.start,
                    startStorageValue = 1,
					missions = {}
					}
			break
		end
		questIndex = questIndex + 1
	end
	
	for i, v in pairs(LARVIK_TASKS["Easy"]) do
	    local values = { 
		                 name = "Easy",
	                     storageId = larvikTask.selectedTaskEasy + i,
		                 missionId = larvikTask.selectedTaskEasy + i,
		                 startValue = 1,
						 endValue = 2,
		                 states = {
					               [1] = "You have to collect " .. larvikTask:getItemList(LARVIK_TASKS["Easy"][i]["Required Items"], true)["String"],
						           [2] = "Task is completed.",
								   [3] = "Mission Expired."
						          }
						}

		table.insert(Quests[questIndex].missions, values)			
	end
	
	for i, v in pairs(LARVIK_TASKS["Medium"]) do
	    local values = { 
		                 name = "Medium",
	                     storageId = larvikTask.selectedTaskMedium + i,
		                 missionId = larvikTask.selectedTaskMedium + i,
		                 startValue = 1,
						 endValue = 2,
		                 states = {
					               [1] = "You have to collect " .. larvikTask:getItemList(LARVIK_TASKS["Medium"][i]["Required Items"], true)["String"],
						           [2] = "Task is completed.",
								   [3] = "Mission Expired."
						          }
						}

		table.insert(Quests[questIndex].missions, values)			
	end
	
	for i, v in pairs(LARVIK_TASKS["Hard"]) do
	    local values = { 
		                 name = "Hard",
	                     storageId = larvikTask.selectedTaskHard + i,
		                 missionId = larvikTask.selectedTaskHard + i,
		                 startValue = 1,
						 endValue = 2,
		                 states = {
					               [1] = "You have to collect " .. larvikTask:getItemList(LARVIK_TASKS["Hard"][i]["Required Items"], true)["String"],
						           [2] = "Task is completed.",
								   [3] = "Mission Expired."
						          }
						}

		table.insert(Quests[questIndex].missions, values)			
	end
	
end

local globalevent = GlobalEvent("load_Larvik")
function globalevent.onStartup()
    local value = larvikTask:getMultiplier()
   -- print("[Larvik Task] - Global Experience Boost: " .. value .. "%.")
	prepare()
	larvikTask:checkUseBoost()
	larvikTask:prepareInformationsTable()
end
globalevent:register()

function larvikTask:countItems(t)

      if not t then
         return nil
      end

      local value = 0

      for index, requireditem in pairs(t) do
          if requireditem.type == "item" then
		     value = value + 1
		  end
	   end
	   
	  return value
end

function larvikTask:addRewards(player, t, text)
            
      if not t then
         return nil
      end
	  
	  local list = "You have received: "
	  
	  for index, v in pairs(t) do
	      if v.type == "item" then
	  	     local id = v.id
		     local count = v.count
			 if not text then
			    player:addItem(id, count)
		     end
			 if index == larvikTask:countItems(t) or larvikTask:countItems(t) == 1 then
			    list = list .. count .. "x " .. getItemName(id)
		     else
			    list = list .. count .. "x " .. getItemName(id) .. ", "
			 end
		  end
	  end
	  
	  local experience = larvikTask:countExperience(t)
	  
	  if experience > 0 then
	     list = list .. " and " .. experience .. " experience."
	  end
	  
	  if text then
	     if text == "finish" then
		    list = list .. " You have finished all tasks, come back tommorow."
		    else
	        list = list .. " Now you can start " .. "{" .. text .. "}" .. " task."
	     end
	     return list
      end
	     
	  larvikTask:addPoints(1)
end

function larvikTask:getItemList(t, method)

    local str = ""
	local list = {}
		  for index, requireditem in pairs(t) do
		      if requireditem.type == "item" then
		         local id = requireditem.id
			     local count = requireditem.count
				 local itemTable = { ["itemid"] = id, ["count"] = count }
				 table.insert(list, itemTable)
		         if index == larvikTask:countItems(t) and larvikTask:countItems(t) > 1 then
				    if method then
					   str = str .. " and " .. count .. "x " .. getItemName(id) .. "."
					   else
			           str = str .. " and " .. count .. "x " .. "{" .. getItemName(id) .. "}" .. "."
					end
				 else
				    if index == larvikTask:countItems(t) - 1 or larvikTask:countItems(t) == 1 then
					   if method then
					      str = str .. count .. "x " .. getItemName(id)
					   else
				          str = str .. count .. "x " .. "{" .. getItemName(id) .. "}"
					   end
					else
					   if method then
					      str = str .. count .. "x " .. getItemName(id) .. ", "
					   else
					      str = str .. count .. "x " .. "{" .. getItemName(id) .. "}" .. ", "
					   end
					end
			    end
		     end
		  end
		  
	local values = { ["String"] = str, ["List"] = list }
    return values
end	

function larvikTask:getMissingItemList(t)
      
	  if not t then
	     return nil
	  end
	  
	  local str = ""
	  for index, missingItem in pairs(t) do
	      local id = missingItem["itemid"]
		  local count = missingItem["count"]
		  
		     if index == #t and #t > 1 then
			        str = str .. " and " .. count .. "x " .. "{" .. getItemName(id) .. "}"
				 else
				    if index == #t - 1 or #t == 1 then
				       str = str .. count .. "x " .. "{" .. getItemName(id) .. "}"
					else
					   str = str .. count .. "x " .. "{" .. getItemName(id) .. "}" .. ", "
					end
		     end
	   end  
	   
	return str
end

function larvikTask:removeItems(player, t)
      
      if not player then 
         return nil
      end
      
      if not t then
         return nil
      end
   	  
	  for index, v in pairs(t) do
	      local id = v["itemid"]
		  local count = v["count"]
	      player:removeItem(id, count)
	  end
	  local pos = player:getPosition()
	  pos:sendMagicEffect(CONST_ME_MAGIC_RED)

end

function larvikTask:countExperience(t)

      if not t then
         return nil
      end

      local value = 0

      for index, requireditem in pairs(t) do
          if requireditem.type == "experience" then
		     value = value + requireditem.value
		  end
	  end
	   
	  return value
end

function larvikTask:getPoints()
            
	local playerData = db.storeQuery("SELECT `points` FROM `game_events` WHERE `name` = 'larvik_npc';")
    if playerData then
       return result.getNumber(playerData, "points")
    end

end

function larvikTask:addPoints(value)
    
	if not value then
	   return nil
	end
	
	local points = 0
	
	local playerData = db.storeQuery("SELECT `points` FROM `game_events` WHERE `name` = 'larvik_npc';")
    if playerData then
       points = result.getNumber(playerData, "points")
    end
	
	return db.query("UPDATE `game_events` SET `points` = '".. points + value .."' WHERE `name` = 'larvik_npc';")
end

function larvikTask:restartPoints()
	local points = 0
	return db.query("UPDATE `game_events` SET `points` = '".. points .."' WHERE `name` = 'larvik_npc';")
end

function larvikTask:prepareInformationsTable()
    
	local t = LARVIK_TASKS["Informations Table"]
	if not t then
	   return nil
	end
		
	local posTable = t["Position"]
	local pos = Position(posTable[1], posTable[2], posTable[3])
	if pos then
	   local tile = Tile(pos)
	   if tile then
	      local items = tile:getItems()
		  if items and #items > 0 then
		     for _, item in pairs(items) do
			     item:setAttribute(ITEM_ATTRIBUTE_ACTIONID, larvikTask.actionid)
		     end
		  end
	   end
	end
end
	
	
-- function larvikTask:getPlayerByGUID(guid)
     -- local resultx = db.storeQuery("SELECT `name` FROM `players` WHERE `id` = " .. guid)
     -- if resultx then
         -- name = result.getDataString(resultx, 'name')
         -- result.free(resultx)
		 -- local player = Player(name)
		 -- if player then
            -- return player:getId()
	     -- end
     -- end
-- end

function larvikTask:getPlayerByGUID(guid)
     local resultx = db.storeQuery("SELECT `name` FROM `players` WHERE `id` = " .. guid)
     if resultx then
         name = result.getDataString(resultx, 'name')
         result.free(resultx)
		 
		 local player = Player(name)
		 if player then
		    local id = player:getId()
            return id
	    end
     end
     return false
end

function larvikTask:sendMessage()
	for _, player in ipairs(Game.getPlayers()) do
		player:sendTextMessage(MESSAGE_EVENT_ADVANCE, "Daily Tasks has been restarted.")
	end
end
	
function larvikTask:getReset()
            
	local playerData = db.storeQuery("SELECT `restarted` FROM `game_events` WHERE `name` = 'larvik_npc';")
    if playerData then
       return result.getNumber(playerData, "restarted")
    end
end

function larvikTask:setRestart(value)
	return db.query("UPDATE `game_events` SET `restarted` = '".. value .."' WHERE `name` = 'larvik_npc';")
end

function larvikTask:getMultiplier()
		local points = larvikTask:getPoints()
		
		if not points or points < 1 then
		   return 0
		end
		
		local value = 0.01
		return points * value
end

function larvikTask:restartMissions()
    
	local playerGUIDT = {}
    local playerData = db.storeQuery("SELECT `player_id` FROM `player_storage`")
   
    if playerData then
        repeat
            local guid = result.getNumber(playerData, "player_id")
            table.insert(playerGUIDT, guid)
        until not result.next(playerData)
    end
	
	local storages = {
	                   larvikTask.start,
	                   larvikTask.selectedTask + 1,
					   larvikTask.selectedTask + 2,
					   larvikTask.selectedTask + 3,
					   larvikTask.isDoingTask + 1,
					   larvikTask.isDoingTask + 2,
					   larvikTask.isDoingTask + 3,
					 }
  
	for i = 1, #playerGUIDT do
	    local guid = playerGUIDT[i]
		for z = 1, #storages do
		        local value = storages[z]
				local player = Player(larvikTask:getPlayerByGUID(guid))
		        if player then
				   player:setStorageValue(value, -1)
				else
			       db.query("DELETE FROM `player_storage` WHERE `key` = "..value.." AND `player_id` = " .. guid)
				end
		end
	end
	
	for i = 1, #playerGUIDT do
	    local guid = playerGUIDT[i]
		for indexEasy, e in pairs(LARVIK_TASKS["Easy"]) do
		    local value = larvikTask.selectedTaskEasy + indexEasy
			local player = Player(larvikTask:getPlayerByGUID(guid))
			if player then
			   player:setStorageValue(value, 3)
			else
			   db.query("DELETE FROM `player_storage` WHERE `key` = "..value.." AND `player_id` = " .. guid)
			end
		end
		
		for indexMedium, m in pairs(LARVIK_TASKS["Medium"]) do
		    local value = larvikTask.selectedTaskMedium + indexMedium
			local player = Player(larvikTask:getPlayerByGUID(guid))
			if player then
			   player:setStorageValue(value, 3)
			else
			   db.query("DELETE FROM `player_storage` WHERE `key` = "..value.." AND `player_id` = " .. guid)
			end
		end
		    
		for indexHard, h in pairs(LARVIK_TASKS["Hard"]) do
		    local value = larvikTask.selectedTaskHard + indexHard
			local player = Player(larvikTask:getPlayerByGUID(guid))
			if player then
			   player:setStorageValue(value, 3)
			else
			   db.query("DELETE FROM `player_storage` WHERE `key` = "..value.." AND `player_id` = " .. guid)
			end
		end
	end
	
end

function larvikTask:sendModal(player)

    if not player then
	   return nil
	end
		
	local title = "World Experience Table"
	local message = "Status: "
	if larvikTask:canUseBoost() then
	   message = message .. "Active"
	else
	   message = message .. "Not Active"
	end
	message = message .. "\n"
	message = message .. "Experience Bonus: " .. larvikTask:getMultiplier() * 100 .. "%"
	message = message .. "\n"
    message = message .. "Players finished world daily tasks " .. larvikTask:getPoints() .. " times"
	message = message .. "\n"
	message = message .. "-----------------------------------"
	message = message .. "\n"
	message = message .. "World Experience Bonus will active at Wednesday." 

	local window = ModalWindow(1361, title, message)
	window:addButton(100, "Ok")
    window:setDefaultEnterButton(100)
    window:setDefaultEscapeButton(100)
	window:sendToPlayer(player)
	return true
end

function larvikTask:sendOnLook()
    
	local message = "Status: "
	if larvikTask:canUseBoost() then
	   message = message .. "Active"
	else
	   message = message .. "Not Active"
	end
	message = message .. "\n"
	message = message .. "Experience Bonus: " .. larvikTask:getMultiplier() * 100 .. "%"
	message = message .. "\n"
    message = message .. "Players finished world daily tasks " .. larvikTask:getPoints() .. " times"
	message = message .. "\n"
	--message = message .. "-----------------------------------"
	--message = message .. "\n"
	message = message .. "World Experience Bonus will active at Wednesday." 
	return message
end    
	
	

function larvikTask:checkUseBoost()
    local t = LARVIK_TASKS["Schedulers"]["Activation Days"]
	
	local currentDay = os.date("%A")
	for i, v in pairs(t) do
	    if v:lower() == currentDay:lower() then
	       larvikTask.canUse = true
		   print("Can use?")
		   return true
		end
	end
	
	return false
end

function larvikTask:canUseBoost()
    if larvikTask.canUse then
	   return true
	end
	return false
end

function larvikTask:setActive(boolean)
    
   if boolean then
      larvikTask.canUse = true
	  return
   end
   larvikTask.canUse = false
end

-- local action = Action()
-- function action.onUse(player, item, fromPosition, target, toPosition, isHotkey)
   -- larvikTask:sendModal(player)
-- return true
-- end
-- action:aid(larvikTask.actionid)
-- action:register()

local talkaction = TalkAction("!resetlarvik")
function talkaction.onSay(player, words, param)
    
	         larvikTask:restartPoints() 
		     larvikTask:restartMissions()
			 larvikTask:sendMessage()
		     dailyRestarted = 1
		     pointsRestarted = 1
		     --print("[Larvik] - Weekly Restarted.")

   return true
end
talkaction:separator(" ")
talkaction:register() 

local talkaction = TalkAction("!larvik")
function talkaction.onSay(player, words, param)
    --larvikTask:sendModal(player)
	
	if larvikTask:canUseBoost() then
	   larvikTask:setActive(false)
	   Game.broadcastMessage("World experience bonus is not activated anymore.", MESSAGE_GAME_HIGHLIGHT)
	else
	   larvikTask:setActive(true)
	   Game.broadcastMessage("World experience bonus is activated!", MESSAGE_GAME_HIGHLIGHT)
	end
	
	
    return false
end
talkaction:separator(" ")
talkaction:register()

if not pointsRestarted then
   pointsRestarted = 0
end

if not dailyRestarted then
   dailyRestarted = 0
end

-- local globalevent = GlobalEvent("larvik_Scheduler")
-- function globalevent.onThink(interval, lastExecution)
    
	-- local currentTime = os.date("%H:%M")
	-- local currentDay = os.date("%A")
	-- local dailyTime = LARVIK_TASKS["Schedulers"]["Daily"].Time
	
	-- --local weeklyTime = LARVIK_TASKS["Schedulers"]["Weekly Points Reset"].Time
	-- local weeklyDay = LARVIK_TASKS["Schedulers"]["Weekly Points Reset"].Day
	
	-- local test = true
	-- if test then
	-- -- if currentDay == weeklyDay then
	   -- -- if currentTime == dailyTime then
	      -- if pointsRestarted == 0 then
	         -- larvikTask:restartPoints() 
		     -- larvikTask:restartMissions()
			 -- larvikTask:sendMessage()
		     -- dailyRestarted = 1
		     -- pointsRestarted = 1
		     -- --print("[Larvik] - Weekly Restarted.")
	      -- end
		-- -- end
		-- return true
	-- end
	
	-- if currentTime == dailyTime then
	   -- if dailyRestarted == 0 then
	     -- -- print("[Larvik] - Daily Restarted.")
		  -- larvikTask:restartMissions()
		  -- dailyRestarted = 1
		  -- larvikTask:sendMessage()
		-- end
	-- end

	-- return true
-- end
-- globalevent:interval(60000 * 5)
-- globalevent:register()

